<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <title>MIDI.js - Sequencing in Javascript.</title>
 <!-- midi.js css -->
 <link href="/css/MIDIPlayer.css" rel="stylesheet" type="text/css" />
 <!-- midi.js package -->
 <script src="/js/Color/SpaceW3.js" type="text/javascript"></script>
 <script src="/js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="/js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="/js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="/js/MIDI/Player.js" type="text/javascript"></script>
 <script src="/js/MusicTheory/Synesthesia.js" type="text/javascript"></script>
 <script src="/js/Widgets/Loader.js" type="text/javascript"></script>
 <script src="/js/Window/Event.js" type="text/javascript"></script>
 <script src="/js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="/js/Window/DOMLoader.script.js" type="text/javascript"></script>
 <!-- jasmid package -->
 <script src="/js/jasmid/stream.js"></script>
 <script src="/js/jasmid/midifile.js"></script>
 <script src="/js/jasmid/replayer.js"></script>
 <!-- extras -->
 <script src="/js/Base64.js" type="text/javascript"></script>
 <script src="/js/base64binary.js" type="text/javascript"></script>
 <script src="/js/jquery-1.7.1-min.js" type="text/javascript"></script>

</head>
<body>
<h1>Text to Audio</h1>
<div style="position: fixed; top: 0; left: 0; z-index: 4; border-radius: 5px; overflow: hidden;" id="colors"></div><div style="text-align: center; border-radius: 5px; position: absolute; top: -70px; left: -40px; opacity: 0.9" id="colors"></div>
<div style="margin-bottom: 50px; border: 1px solid #000; background: rgba(255,255,255,0.5); border-radius: 10px; float: left; width: 800px; padding-bottom: 100px; position: relative; z-index: 2;">
 <div class="player" style="height: 42px; box-shadow: 0 -1px #000; margin-bottom: 0; border-bottom-right-radius: 0; border-bottom-left-radius: 0;">
  <div style="margin: 0 auto; width: 160px; float: right;">
  <input type="image" src="./images/pause.png" align="absmiddle" value="pause" onclick="pausePlayStop()" id="pausePlayStop">
  <input type="image" src="./images/stop.png" align="absmiddle" value="stop" onclick="pausePlayStop(true)">
  <input type="image" src="./images/backward.png" align="absmiddle" value="stop" onclick="player.getNextSong(-1);">
  <input type="image" src="./images/forward.png" align="absmiddle" value="stop" onclick="player.getNextSong(+1);">
  </div>
  <div class="time-controls" style="float: left; margin: 0; position: relative; top: 5px;">
   <span id="time1" class="time">0:00</span>
   <span id="capsule">
	<span id="cursor"></span>
   </span>
   <span id="time2" class="time" style="text-align: left;">-0:00</span>
  </div>
 </div>
 <div id="textForm" style="background: rgba(255,255,0,0.5); position: relative;color: #000; z-index: -1;padding: 5px 11px 5px;">
     <p>Enter text to convert: </p>
     <form method="POST" action="javascript:submitForm();">
         <textarea rows="5" cols="80" id="textToConvert" name="textToConvert" value=""></textarea>
         <input type="submit" id="submit" name="convertText" value="Convert Text"/>
     </form>
     <div>
        <a href="javascript:selectPoem(0);">The Lady of Shallot - Tennyson</a><br/>
        <a href="javascript:selectPoem(1);">The charge of the light brigade - Tennyson</a><br/>
    </div>
 </div>
<script type="text/javascript">


if (typeof(console) === "undefined") var console = { log: function() { } };

// Begin loading indication.
var player;

// MIDI files from Disklavier World
var songid = 0;
var song = [
];

function submitForm(){
    var textToConvert = $('#textToConvert').val();
    $.ajax({
        type: "POST",
        url: "/texttomidi",
        contentType: "application/json",
        data: JSON.stringify({textToConvert: textToConvert})
    }).done(function(data){
            song[0] = data.midibase64;
            player.loadFile(song[0], player.start)
            }).fail(function(){
                alert("oops");
            });
}


var poems = [
        "Part I.\n\nOn either side the river lie\nLong fields of barley and of rye,\nThat clothe the wold and meet the sky;\nAnd thro' the field the road runs by\nTo many-tower'd Camelot;\nAnd up and down the people go,\nGazing where the lilies blow\nRound an island there below,\nThe island of Shalott.\n\nWillows whiten, aspens quiver,\nLittle breezes dusk and shiver\nThro' the wave that runs for ever\nBy the island in the river\nFlowing down to Camelot.\nFour gray walls, and four gray towers,\nOverlook a space of flowers,\nAnd the silent isle imbowers\nThe Lady of Shalott.\n\nBy the margin, willow-veil'd\nSlide the heavy barges trail'd\nBy slow horses; and unhail'd\nThe shallop flitteth silken-sail'd\nSkimming down to Camelot:\nBut who hath seen her wave her hand?\nOr at the casement seen her stand?\nOr is she known in all the land,\nThe Lady of Shalott?\n\nOnly reapers, reaping early\nIn among the bearded barley,\nHear a song that echoes cheerly\nFrom the river winding clearly,\nDown to tower'd Camelot:\nAnd by the moon the reaper weary,\nPiling sheaves in uplands airy,\nListening, whispers \"'Tis the fairy\nLady of Shalott.\"\n\nPart II.\n\nThere she weaves by night and day\nA magic web with colours gay.\nShe has heard a whisper say,\nA curse is on her if she stay\nTo look down to Camelot.\nShe knows not what the curse may be,\nAnd so she weaveth steadily,\nAnd little other care hath she,\nThe Lady of Shalott.\n\nAnd moving thro' a mirror clear\nThat hangs before her all the year,\nShadows of the world appear.\nThere she sees the highway near\nWinding down to Camelot:\nThere the river eddy whirls,\nAnd there the surly village-churls,\nAnd the red cloaks of market girls,\nPass onward from Shalott.\n\nSometimes a troop of damsels glad,\nAn abbot on an ambling pad,\nSometimes a curly shepherd-lad,\nOr long-hair'd page in crimson clad,\nGoes by to tower'd Camelot;\nAnd sometimes thro' the mirror blue\nThe knights come riding two and two:\nShe hath no loyal knight and true,\nThe Lady of Shalott.\n\nBut in her web she still delights\nTo weave the mirror's magic sights,\nFor often thro' the silent nights\nA funeral, with plumes and lights\nAnd music, went to Camelot:\nOr when the moon was overhead,\nCame two young lovers lately wed;\n\"I am half-sick of shadows,\" said\nThe Lady of Shalott.\n\nPart III.\n\nA bow-shot from her bower-eaves,\nHe rode between the barley-sheaves,\nThe sun came dazzling thro' the leaves,\nAnd flamed upon the brazen greaves\nOf bold Sir Lancelot.\nA redcross knight for ever kneel'd\nTo a lady in his shield,\nThat sparkled on the yellow field,\nBeside remote Shalott.\n\nThe gemmy bridle glitter'd free,\nLike to some branch of stars we see\nHung in the golden Galaxy.\nThe bridle-bells rang merrily\nAs he rode down to Camelot:\nAnd from his blazon'd baldric slung\nA mighty silver bugle hung,\nAnd as he rode his armour rung,\nBeside remote Shalott.\n\nAll in the blue unclouded weather\nThick-jewell'd shone the saddle-leather,\nThe helmet and the helmet-feather\nBurn'd like one burning flame together,\nAs he rode down to Camelot.\nAs often thro' the purple night,\nBelow the starry clusters bright,\nSome bearded meteor, trailing light,\nMoves over still Shalott.\n\nHis broad clear brow in sunlight glow'd;\nOn burnish'd hooves his war-horse trode;\nFrom underneath his helmet flow'd\nHis coal-black curls as on he rode,\nAs he rode down to Camelot.\nFrom the bank and from the river\nHe flash'd into the crystal mirror,\n\"Tirra lirra,\" by the river\nSang Sir Lancelot.\n\nShe left the web, she left the loom,\nShe made three paces thro' the room,\nShe saw the water-lily bloom,\nShe saw the helmet and the plume,\nShe look'd down to Camelot.\nOut flew the web and floated wide;\nThe mirror crack'd from side to side;\n\"The curse is come upon me,\" cried\nThe Lady of Shalott.\n\nPart IV.\n\nIn the stormy east-wind straining,\nThe pale-yellow woods were waning,\nThe broad stream in his banks complaining,\nHeavily the low sky raining\nOver tower'd Camelot;\nDown she came and found a boat\nBeneath a willow left afloat,\nAnd round about the prow she wrote\nThe Lady of Shalott.\n\nAnd down the river's dim expanse--\nLike some bold seër in a trance,\nSeeing all his own mischance--\nWith a glassy countenance\nDid she look to Camelot.\nAnd at the closing of the day\nShe loosed the chain, and down she lay;\nThe broad stream bore her far away,\nThe Lady of Shalott.\n\nLying, robed in snowy white\nThat loosely flew to left and right--\nThe leaves upon her falling light--\nThro' the noises of the night\nShe floated down to Camelot:\nAnd as the boat-head wound along\nThe willowy hills and fields among,\nThey heard her singing her last song,\nThe Lady of Shalott.\n\nHeard a carol, mournful, holy,\nChanted loudly, chanted lowly,\nTill her blood was frozen slowly,\nAnd her eyes were darken'd wholly,\nTurn'd to tower'd Camelot;\nFor ere she reach'd upon the tide\nThe first house by the water-side,\nSinging in her song she died,\nThe Lady of Shalott.\n\nUnder tower and balcony,\nBy garden-wall and gallery,\nA gleaming shape she floated by,\nA corse between the houses high,\nSilent into Camelot.\nOut upon the wharfs they came,\nKnight and burgher, lord and dame,\nAnd round the prow they read her name,\nThe Lady of Shalott.\n\nWho is this? and what is here?\nAnd in the lighted palace near\nDied the sound of royal cheer;\nAnd they cross'd themselves for fear,\nAll the knights at Camelot:\nBut Lancelot mused a little space;\nHe said, \"She has a lovely face;\nGod in his mercy lend her grace,\nThe Lady of Shalott.\"\"\n",
        "Half a league, half a league,\n  Half a league onward,\nAll in the valley of Death,\n  Rode the six hundred.\n'Forward, the Light Brigade!\nCharge for the guns' he said:\nInto the valley of Death\n  Rode the six hundred.\n\n'Forward, the Light Brigade!'\nWas there a man dismay'd?\nNot tho' the soldiers knew\n  Some one had blunder'd:\nTheirs not to make reply,\nTheirs not to reason why,\nTheirs but to do and die:\nInto the valley of Death\n  Rode the six hundred.\n\nCannon to right of them,\nCannon to left of them,\nCannon in front of them\n  Volley'd and thunder'd;\nStorm'd at with shot and shell,\nBoldly they rode and well,\nInto the jaws of Death,\nInto the mouth of Hell\n  Rode the six hundred.\n\nFlash'd all their sabres bare,\nFlash'd as they turned in air\nSabring the gunners there,\nCharging an army while\n  All the world wonder'd:\nPlunged in the battery-smoke\nRight thro' the line they broke;\nCossack and Russian\nReel'd from the sabre-stroke\nShatter'd and sunder'd.\nThen they rode back, but not\nNot the six hundred.\n\nCannon to right of them,\nCannon to left of them,\nCannon behind them\n  Volley'd and thunder'd;\nStorm'd at with shot and shell,\nWhile horse and hero fell,\nThey that had fought so well\nCame thro' the jaws of Death,\nBack from the mouth of Hell,\nAll that was left of them,\n  Left of six hundred.\n\nWhen can their glory fade?\nO the wild charge they made!\n  All the world wonder'd.\nHonour the charge they made!\nHonour the Light Brigade,\n  Noble six hundred!\n"
];

function selectPoem(index){
    $('#textToConvert').val(poems[index]);
}

// Toggle between Pause and Play modes.
var pausePlayStop = function(stop) {
	var d = document.getElementById("pausePlayStop");
	if (stop) {
		MIDI.Player.stop();
		d.src = "./images/play.png";
	} else if (MIDI.Player.playing) {
		d.src = "./images/play.png";
		MIDI.Player.pause(true);
	} else {
		d.src = "./images/pause.png";
		MIDI.Player.resume();
	}
};

Event.add(window, "load", function(event) {
	var link = document.createElement('link');
	link.href = 'http://fonts.googleapis.com/css?family=Oswald';
	link.ref = "stylesheet";
	link.type = "text/css";
	document.body.appendChild(link);
	var link = document.createElement('link');
	link.href = 'http://fonts.googleapis.com/css?family=Andada';
	link.ref = "stylesheet";
	link.type = "text/css";
	document.body.appendChild(link);
	// load up the piano keys
	var colors = document.getElementById("colors");
	var colorElements = [];
	for (var n = 0; n < 88; n ++) {
		var d = document.createElement("div");
		d.innerHTML = MIDI.noteToKey[n+21];
		colorElements.push(d);
		colors.appendChild(d);
	}
	//
	MIDI.loader = new widgets.Loader;
	MIDI.loadPlugin(function () {
		// this is the language we are running in
		//var title = document.getElementById("title");
		//title.innerHTML = "Sound being generated with " + MIDI.lang + ".";
		// this sets up the MIDI.Player and gets things going...
		player = MIDI.Player;
		player.timeWarp = 1; // speed the song is played back
		//player.loadFile(song[0], player.start);
		// control the piano keys colors
		var colorMap = MusicTheory.Synesthesia.map();
		player.addListener(function(data) {
			var pianoKey = data.note - MIDI.pianoKeyOffset;
			var d = colorElements[pianoKey];
			if (data.message === 144) {
				var map = colorMap[data.note - 27];
				if (map) d.style.background = map.hex;
				d.style.color = "#fff";
			} else {
				d.style.background = "";
				d.style.color = "";
			}
		});
		//
		ColorSphereBackground();
		MIDIPlayerPercentage(player);
		//
		MIDI.loader.stop();
	});
});

///////  ///////

var MIDIPlayerPercentage = function(player) {
	// update the timestamp
	var time1 = document.getElementById("time1");
	var time2 = document.getElementById("time2");
	var capsule = document.getElementById("capsule");
	var timeCursor = document.getElementById("cursor");
	//
	Event.add(capsule, "drag", function (event, self) {
		Event.cancel(event);
		player.currentTime = (self.x) / 420 * player.endTime;
		if (player.currentTime < 0) player.currentTime = 0;
		if (player.currentTime > player.endTime) player.currentTime = player.endTime;
		if (self.state === "down") {
			player.pause(true);
		} else if (self.state === "up") {
			player.resume();
		}
	});
	//
	function timeFormatting(n) {
		var minutes = n / 60 >> 0; 
		var seconds = String(n - (minutes * 60) >> 0);
		if (seconds.length == 1) seconds = "0" + seconds;
		return minutes + ":" + seconds;
	};
	player.getNextSong = function(n) {
		var id = Math.abs((songid += n) % song.length);
		player.loadFile(song[id], player.start); // load MIDI
	};
	player.setAnimation(function(data, element) {
		var percent = data.now / data.end;
		var now = data.now >> 0; // where we are now
		var end = data.end >> 0; // end of song
		if (now === end) { // go to next song
			var id = ++ songid % song.length;
			player.loadFile(song[id], player.start); // load MIDI
		}
		// display the information to the user
		timeCursor.style.width = (percent * 100) + "%";
		time1.innerHTML = timeFormatting(now);
		time2.innerHTML = "-" + timeFormatting(end - now);
	});
};

/////// SPHERE ///////

var ColorSphereBackground = function() {
	var d = document;
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext("2d");
	canvas.style.cssText = "position: fixed; left: 0; top: 0; opacity: 1";
	canvas.style.width = window.innerWidth + "px";
	canvas.style.height = window.innerHeight + "px";
	document.body.appendChild(canvas);
	//
	Event.add(window, "resize", function() {
		canvas.style.width = window.innerWidth + "px";
		canvas.style.height = window.innerHeight + "px";
		ctx.drawImage(theSphere = sphere(percent), 0, 0)
	});
	Event.add(d, "scroll", function(e) {
		var percent = 1 - document.body.scrollTop / document.body.scrollHeight;
		ctx.drawImage(theSphere = sphere(percent), 0, 0);
		onMouseMove();
	});

	var theSphere;
	var px = window.innerWidth / 2;
	var py = window.innerHeight / 2;
	var onMouseMove = function(event) {
		ctx.drawImage(theSphere, 0, 0);
		if (event) {
			var coords = Event.proxy.getCoord(event);
			coords.x -= document.body.scrollLeft;
			coords.y -= document.body.scrollTop;
			px = coords.x;
			py = coords.y;
		} else { // 
			var coords = { x: px, y: py };
		}
		//
		var x = (coords.x / window.innerWidth) * 255 - 127; // grab mouse pixel coords, center at midpoint
		var y = (coords.y / window.innerHeight) * 255 - 127;
		var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); // get image data
		var data = imageData.data;
		for(var n = 0, length = data.length; n < length; n += 4) {
			data[n] = data[n] + x - y; // red (control left)
			data[n + 1] = data[n + 1] - x - y; // green (control right)
			data[n + 2] = data[n + 2] + y + y; // blue (control down)
		}
		ctx.putImageData(imageData, 0, 0);
	};
	Event.add(d, "mousemove", onMouseMove);
	//
	function sphere(top) { // create Sphere image, and apply to <canvas>
		var canvas1 = document.createElement("canvas");
		var ctx = canvas1.getContext("2d");
		var w = 75;
		var left = -20;
		var top = top * -50;
		canvas.width = canvas1.width = w * window.innerWidth / window.innerHeight;
		canvas.height = canvas1.height = w;
		ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
		n = 360; while(n--) { // go through hues
			var x = left + w;
			var y = top + w;
			var g = ctx.createLinearGradient(x, top, x, y);
			g.addColorStop(0, "#000");
			g.addColorStop(.5, "hsl("+((n + 60) % 360)+",100%,50%)");
			g.addColorStop(1, "#FFF");
			ctx.beginPath(); // draw triangle
			ctx.moveTo(x, top);
			ctx.lineTo(x, y);
			ctx.lineTo(x + 2, y);
			ctx.lineTo(x + 5, top);
			ctx.fillStyle = g; // apply gradient
			ctx.fill();
			ctx.translate(x, y); // rotate + translate into position
			ctx.rotate((1 / 360) * Math.PI * 2);
			ctx.translate(-x, -y);
		}
		return canvas1;
	};
	//
	var percent = 1 - document.body.scrollTop / document.body.scrollHeight;
	ctx.drawImage(theSphere = sphere(percent), 0, 0)
};


</script>
</body>
</html>